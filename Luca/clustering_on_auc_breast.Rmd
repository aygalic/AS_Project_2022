---
title: "clustering on auc"
author: "Luca"
date: '2022-05-08'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/lucamainini/Documents/GitHub/AS_Project_2022')
```

## Import of data [to be skipped]

```{r functions}
#import nate's and luca's function
source(file.path("nate", "utils", "nate_utils.R"))
source(file.path("Luca", "luca_utils.R"))
```

```{r import data}
#path="/Users/lucamainini/Documents/GitHub/AS_Project_2022/Dataset"
path="Dataset"
result <- import_dataset(path)
auc=result$auc
rpkm=result$rpkm
rm(result)
```

We work only on Breast cells

```{r selection of breast}
#data_expression= read.delim(file.path("Dataset", "data_mrna_seq_rpkm.txt"), header = TRUE, comment.char = '#')
name_cols <- data_expression[,1]


sub_rpkm <-block_dat(cancers, rpkm) #otteniamo 46 valori invece dei 53 disponibili (in auc non li abbiamo li altri)
rpkm_breast <- cbind(sub_rpkm, name_cols)
View(sub_rpkm)
dim(sub_rpkm)
```

```{r}
breast_auc<-block_dat(c("BREAST"), auc)
breast_auc = t(breast_auc)

#apply Roberta's function
```

## LOAD DIRECTLY

```{r load data}
#save(breast_data_treatment_auc, file = "breast_auc_data.Rdata")
load(file.path("Dataset","breast_auc_data.Rdata"))
breast_auc = t(breast_data_treatment_auc)
```

```{r}
#install.packages("zoo")                                    # Install & load zoo package
library("zoo")
```

```{r substituting the NA with the average efficacy of the treatment}
breast_auc = na.aggregate(t(breast_data_treatment_auc))
```

```{r}
library(plotly)
fig <- plot_ly(
    x = colnames(breast_auc), y = rownames(breast_auc),
    colors = colorRamp(c("red", "green")),
    z = as.matrix(breast_auc), type = "heatmap"
)  
fig
```

```{r}
treatment_means = apply(breast_auc,2,mean)
temp = treatment_means>0.98
treatment_means[treatment_means>0.98]
```

```{r}
data_5 <- breast_auc[,temp]
apply(data_5,2,mean)
library(plotly)
fig <- plot_ly(
    x = colnames(data_5), y = rownames(data_5),
    colors = colorRamp(c("red", "green")),
    z = as.matrix(data_5), type = "heatmap"
)  
fig
```
## VISUALIZATION OF DATA
```{r}
load(GGally)
```

```{r}
data_p = data.frame(data_5)
row.names(data_p)=row.names(data_5)
ggpairs(data_p, # data.frame with variables
             columns = 1:5,
             #aes(colour=class, alpha = 0.5)
        )
```


## PCA

![](images/paste-BD67534A.png)

```{r pca space}
pca <- princomp(data_5, scores=T)

# Loadings
load<- pca$loadings #eigen(S)
load

#x11()
par(mar = c(1,4,0,2), mfrow = c(5,1))
for(i in 1:5)
  barplot(load[,i], ylim = c(-1, 1))

# plot on the space generated by the first k principal components
M <- sapply(data_5[,1:3],mean)
S <- cov(data_5[,1:3])

open3d()
points3d(pca$scores[,1:3], asp=1, size=5)
axes3d()


```
```{r}
cat("Outliers detection for PCs: \n")
for(i in 1:5){
  chosen <- paste("Comp.", i, sep = "")
  chosen <- scores[[chosen]]
  out<-boxplot.stats(chosen)$out
  cat("PC ", i, ": ", which(chosen %in% c(out)), "\n")
}
```

```{r}
# We plot the outlying data for the first 2 PCs
color.outliers <- NULL
for (i in 1:dim(data_5)[1]){
  color.outliers[i] <- 'blue'
}

outliers_1 <- c(26) #pc1
outliers_2 <- c(9, 10, 12, 21, 25, 43 ) #pc2
outliers_2_3 <- c(9, 12, 25, 43 ) #pc2_3
outliers_3 <- c(9, 12, 20, 26, 43 ) #pc2

for (i in outliers_1){
  color.outliers[i] <- 'red'
}

for (i in outliers_2){
  color.outliers[i] <- 'green'
}

for (i in outliers_3){
  color.outliers[i] <- 'orange'
}

for (i in outliers_2_3){
  color.outliers[i] <- 'brown'
}

pairs(data, col=color.outliers, pch=16, main='Scatter plot - Outliers')


open3d()
points3d(pca$scores[,1:3],col=color.outliers, asp=1, size=5)
title3d("PCA scores", xlab="PC1", ylab="PC2", zlab="PC3")
axes3d()

open3d(windowRect=c(100,100,1000,1000))
points3d(data_5[,1:3],col=color.outliers, asp=1, size=5)
title3d("OUTLIERS on first 3 treatments direction", xlab="AVA", ylab= 
          "BIC", zlab="LIN")
axes3d()
```


## HIERARCHICAL CLUSTERING
```{r}
library(mvtnorm)
library(rgl)
library(car)
```

```{r dissimilarity_matrix of ordered data}
# compute the dissimilarity matrix of the data
# we choose the Euclidean metric (and then we look at other metrics)

#help(dist)
d.e <- dist(data_5, method='euclidean')

image(1:44,1:44,as.matrix(d.e), main='metrics: Euclidean', asp=1, xlab='i', ylab='j')

# with other metrics:
d.m <- dist(data_5, method='manhattan')
d.c <- dist(data_5, method='canberra')

##xquartz()
par(mfrow=c(1,3))
image(1:44,1:44,as.matrix(d.e), main='metrics: Euclidean', asp=1, xlab='i', ylab='j' )
image(1:44,1:44,as.matrix(d.c), main='metrics: Canberra', asp=1, xlab='i', ylab='j' )
image(1:44,1:44,as.matrix(d.m), main='metrics: Manhattan', asp=1, xlab='i', ylab='j' )
```

```{r}
fig <- plot_ly(
    #x = colnames(data_5), y = rownames(data_5),
    #colors = colorRamp(c("red", "green")),
    z = as.matrix(d.e), type = "heatmap"
)  
fig
```

Le matrici sembrano simili, da cui ipotizziamo che cambiare la distanza non porterÃ  a grandi differenze.

```{r euclidian}
d.es <- hclust(d.e, method='single')
d.ea <- hclust(d.e, method='average')
d.ec <- hclust(d.e, method='complete')

ward <- hclust(d.e, method='ward.D2')

# plot of the dendrograms
##xquartz()
par(mfrow=c(1,3))
plot(d.es, main='euclidean-single', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
plot(d.ec, main='euclidean-complete', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
plot(d.ea, main='euclidean-average', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')

# plot dendrograms (with eucledian it seems 2 clusters)
##xquartz()
par(mfrow=c(1,3))
plot(d.es, main='euclidean-single', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
rect.hclust(d.es, k=2)
plot(d.ec, main='euclidean-complete', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
rect.hclust(d.ec, k=3)
plot(d.ea, main='euclidean-average', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
rect.hclust(d.ea, k=4)

#plot(ward, hang=-0.1, labels=FALSE, main='ward', xlab='', sub='')

# How to cut a Dendrogram?
# We generate vectors of labels through the command cutree()
#help(cutree)

# Fix k=2 clusters:
cluster.ec <- cutree(d.ec, k=2) # euclidean-complete:
cluster.ec

cluster.es <- cutree(d.es, k=3) # euclidean-single
cluster.ea <- cutree(d.ea, k=4) # euclidean-average

cluster.ew <- cutree(ward, k=4) #ward divide il gruppo grosso in 2


points3d(data_5[,1:3],col=color.outliers, asp=1, size=5)
title3d("OUTLIERS on first 3 treatments direction", )

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.ew +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.w))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.es +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.es))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)


open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.ea +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.ea))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.ec +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.ec))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)
```

```{r}
pairs(data_5 , col=cluster.es+1, asp=1, pch=16, lwd=2)
pairs(data_5 , col=cluster.ec+1, asp=1, pch=16, lwd=2)
pairs(data_5 , col=cluster.ea+1, asp=1, pch=16, lwd=2)
pairs(data_5 , col=cluster.w+1, asp=1, pch=16, lwd=2)
```

```{r cophenetic}
coph.es <- cophenetic(d.es)
coph.ec <- cophenetic(d.ec)
coph.ea <- cophenetic(d.ea)
coph.w <- cophenetic(ward)

layout(rbind(c(0,1,0,0),c(2,3,4,5)))
image(as.matrix(d.e), main='Euclidean', asp=1 )
image(as.matrix(coph.es), main='Single', asp=1 )
image(as.matrix(coph.ec), main='Complete', asp=1 )
image(as.matrix(coph.ea), main='Average', asp=1 )
image(as.matrix(coph.w), main='Ward', asp=1 )

# compute cophenetic coefficients
es <- cor(d.e, coph.es)
ec <- cor(d.e, coph.ec)
ea <- cor(d.e, coph.ea)
ew <- cor(d.e, coph.w)
c("Eucl-Single"=es,"Eucl-Compl."=ec,"Eucl-Ave."=ea, "Ward"=ew )
```

AVERAGE 4 IS THE ONE RETAINED

```{r}
data_p = data.frame(data_5)
row.names(data_p)=row.names(data_5)
data_p$class = as.factor(cluster.ec)
ggpairs(data_p, # data.frame with variables
             columns = 1:5,
             aes(colour=class, alpha = 0.5)
        )

```

```{r camperra}
d.cs <- hclust(d.c, method='single')
d.ca <- hclust(d.c, method='average')
d.cc <- hclust(d.c, method='complete')
d.cw <- hclust(d.c, method='ward.D2')

# plot of the dendrograms
##xquartz()
par(mfrow=c(1,3))
plot(d.cs, main='euclidean-single', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
plot(d.cc, main='euclidean-complete', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
plot(d.ca, main='euclidean-average', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')

##xquartz()
par(mfrow=c(1,3))
plot(d.cs, main='euclidean-single', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
rect.hclust(d.cs, k=2)
plot(d.cc, main='euclidean-complete', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
rect.hclust(d.cc, k=3)
plot(d.ca, main='euclidean-average', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
rect.hclust(d.ca, k=4)

#plot(d.cw, main='euclidean-average', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
#rect.hclust(d.cw, k=2)

# How to cut a Dendrogram?
# We generate vectors of labels through the command cutree()
#help(cutree)

# Fix k=2 clusters:

cluster.cs <- cutree(d.cs, k=2) # euclidean-single
cluster.cc <- cutree(d.cc, k=3) # euclidean-complete:
cluster.ca <- cutree(d.ca, k=4) # euclidean-average
cluster.cw <- cutree(d.ca, k=2) # euclidean-average

pairs(data_5 , col=cluster.cs+1, asp=1, pch=16, lwd=2)
pairs(data_5 , col=cluster.cc+1, asp=1, pch=16, lwd=2)
pairs(data_5 , col=cluster.ca+1, asp=1, pch=16, lwd=2)

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.cw +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.cw))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.cs +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.cs))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)



open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.ca +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.ca))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)


open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.cc +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.cc))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)


```

```{r camperra cophenetic}
coph.cs <- cophenetic(d.es)
coph.cc <- cophenetic(d.ec)
coph.ca <- cophenetic(d.ea)
coph.cw <- cophenetic(d.cw)

layout(rbind(c(0,1,0,0),c(2,3,4,5)))
image(as.matrix(d.e), main='Euclidean', asp=1 )
image(as.matrix(coph.es), main='Single', asp=1 )
image(as.matrix(coph.ec), main='Complete', asp=1 )
image(as.matrix(coph.ea), main='Average', asp=1 )
image(as.matrix(coph.cw), main='Ward', asp=1 )

# compute cophenetic coefficients
es <- cor(d.e, coph.es)
ec <- cor(d.e, coph.ec)
ea <- cor(d.e, coph.ea)
ew <- cor(d.e, coph.cw)
c("Eucl-Single"=es,"Eucl-Compl."=ec,"Eucl-Ave."=ea, "Ward"=ew )
```

```{r manhattan}
d.m <- dist(data_5, method='manhattan')
d.ms <- hclust(d.m, method='single')
d.ma <- hclust(d.m, method='average')
d.mc <- hclust(d.m, method='complete')

d.mw <- hclust(d.m, method='ward.D2')

# plot of the dendrograms
##xquartz()
par(mfrow=c(1,3))
plot(d.ms, main='euclidean-single', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
plot(d.mc, main='euclidean-complete', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
plot(d.ma, main='euclidean-average', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')

# plot dendrograms (with eucledian it seems 2 clusters)
##xquartz()
par(mfrow=c(1,3))
plot(d.ms, main='euclidean-single', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
rect.hclust(d.ms, k=3)
plot(d.mc, main='euclidean-complete', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
rect.hclust(d.mc, k=4)
plot(d.ma, main='euclidean-average', hang=-0.1, xlab='', labels=F, cex=0.6, sub='')
rect.hclust(d.ma, k=4)

#plot(ward, hang=-0.1, labels=FALSE, main='ward', xlab='', sub='')

# How to cut a Dendrogram?
# We generate vectors of labels through the command cutree()
#help(cutree)

# Fix k=2 clusters:
cluster.mc <- cutree(d.mc, k=3) # euclidean-complete

cluster.ms <- cutree(d.ms, k=4) # euclidean-single
cluster.ma <- cutree(d.ma, k=4) # euclidean-average

cluster.mw <- cutree(d.mw, k=2) #ward divide il gruppo grosso in 2

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.mw +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.mw))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.ms +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.ms))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.ma +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.ma))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=cluster.mc +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = deparse(substitute(cluster.mc))
title3d(title)
axes3d()
name = paste(title, "png", sep = ".")
rgl.snapshot(filename = name)
```

```{r}
pairs(data_5 , col=cluster.ms+1, asp=1, pch=16, lwd=2)
pairs(data_5 , col=cluster.mc+1, asp=1, pch=16, lwd=2)
pairs(data_5 , col=cluster.ma+1, asp=1, pch=16, lwd=2)
pairs(data_5 , col=cluster.mw+1, asp=1, pch=16, lwd=2)
```

```{r camperra cophenetic}
coph.cs <- cophenetic(d.es)
coph.cc <- cophenetic(d.ec)
coph.ca <- cophenetic(d.ea)
coph.cw <- cophenetic(d.cw)

layout(rbind(c(0,1,0,0),c(2,3,4,5)))
image(as.matrix(d.e), main='Euclidean', asp=1 )
image(as.matrix(coph.es), main='Single', asp=1 )
image(as.matrix(coph.ec), main='Complete', asp=1 )
image(as.matrix(coph.ea), main='Average', asp=1 )
image(as.matrix(coph.cw), main='Ward', asp=1 )

# compute cophenetic coefficients
es <- cor(d.e, coph.es)
ec <- cor(d.e, coph.ec)
ea <- cor(d.e, coph.ea)
ew <- cor(d.e, coph.cw)
c("Eucl-Single"=es,"Eucl-Compl."=ec,"Eucl-Ave."=ea, "Ward"=ew )
```

## K-MEANS

```{r}
result.k <- kmeans(data_5, centers=3) # Centers: fixed number of clusters

#library(factoextra)
fviz_nbclust(data_5, FUN = kmeans, method = "silhouette") 
fviz_nbclust(data_5, FUN = kmeans, method = "wss")
# 3 clusters being optimal, could go to 7

# experimenting with the number of clusters
result.k <- kmeans(M, centers=4) # Centers: fixed number of clusters

open3d(windowRect=c(100,100,1000,1000))
plot3d(data_5, size=3, col=result.k$cluster +1, aspect = F, xlab="AVA", ylab= 
          "BIC", zlab="LIN") 
title = "K-means cluster (4)"
title3d(title)
axes3d()
rgl.snapshot(filename = "auc_4_means.png")
```

